let currentResult="",currentConfig={},quotesConfig={},batchFiles=[],batchResults=[],autoPreviewEnabled=!0,previewDebounceTimer=null;function initializeApp(){document.getElementById("fileInput").addEventListener("change",handleFileUpload),document.getElementById("convertBtn").addEventListener("click",convertText),document.getElementById("configBtn").addEventListener("click",openConfigModal),document.getElementById("downloadBtn").addEventListener("click",downloadResult),document.getElementById("addConfigBtn").addEventListener("click",addConfigItem),document.getElementById("saveConfigBtn").addEventListener("click",saveConfig),document.getElementById("addCustomQuoteBtn").addEventListener("click",addCustomQuoteOption),document.getElementById("formatTextBtn").addEventListener("click",formatText),document.getElementById("helpBtn").addEventListener("click",()=>openModal("helpModal")),document.getElementById("batchProcessBtn").addEventListener("click",openBatchModal),document.getElementById("batchFileInput").addEventListener("change",updateBatchFileList),document.getElementById("startBatchBtn").addEventListener("click",startBatchConversion),document.getElementById("downloadBatchResultBtn").addEventListener("click",handleBatchDownload),document.getElementById("previewModeBtn").addEventListener("click",showDialoguePreview),document.getElementById("formatTextSplitBtn").addEventListener("click",formatTextSplit),document.getElementById("splitConvertBtn").addEventListener("click",updateSplitPreview),document.getElementById("splitDownloadBtn").addEventListener("click",downloadSplitResult),document.getElementById("autoPreviewCheckbox").addEventListener("change",e=>{(autoPreviewEnabled=e.target.checked)&&updateSplitPreview()}),document.getElementById("splitQuoteConfigBtn").addEventListener("click",openSplitQuoteModal),document.getElementById("addSplitCustomQuoteBtn").addEventListener("click",addSplitCustomQuoteOption),document.getElementById("splitNarratorName").addEventListener("input",e=>{document.getElementById("narratorName").value=e.target.value,autoPreviewEnabled&&debouncePreview()}),document.querySelectorAll(".view-btn").forEach(e=>{e.addEventListener("click",switchView)}),document.querySelectorAll(".preview-mode-btn").forEach(e=>{e.addEventListener("click",switchPreviewMode)}),document.getElementById("splitInputText").addEventListener("input",debouncePreview),document.getElementById("inputText").addEventListener("input",syncTextAreas),document.getElementById("splitInputText").addEventListener("input",syncTextAreas),document.getElementById("narratorName").addEventListener("input",e=>{document.getElementById("splitNarratorName").value=e.target.value}),initializeSplitResizer(),setupFileDragDrop(),loadConfig()}function switchView(e){let t=e.target.dataset.view;document.querySelectorAll(".view-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),document.querySelectorAll(".view-content").forEach(e=>e.classList.remove("active")),document.getElementById(t+"View").classList.add("active"),"split"===t&&(syncTextAreas(),syncConfigToSplit(),autoPreviewEnabled&&updateSplitPreview())}function switchPreviewMode(e){let t=e.target.dataset.mode;document.querySelectorAll(".preview-mode-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),"json"===t?(document.getElementById("splitPreviewJson").style.display="block",document.getElementById("splitPreviewDialogue").style.display="none"):(document.getElementById("splitPreviewJson").style.display="none",document.getElementById("splitPreviewDialogue").style.display="block")}function syncTextAreas(){let e=document.getElementById("inputText").value,t=document.getElementById("splitInputText").value;document.getElementById("classicView").classList.contains("active")?document.getElementById("splitInputText").value=e:document.getElementById("inputText").value=t}function debouncePreview(){autoPreviewEnabled&&(clearTimeout(previewDebounceTimer),previewDebounceTimer=setTimeout(()=>{updateSplitPreview()},500))}async function updateSplitPreview(){let e=document.getElementById("splitInputText").value.trim();if(!e){document.querySelector("#splitPreviewJson code").textContent="// 请输入文本以查看预览",document.getElementById("splitPreviewDialogue").innerHTML='<p style="text-align: center; color: #718096;">请输入文本以查看预览</p>';return}let t=document.getElementById("splitNarratorName").value||" ",n=getSelectedQuotes();try{let l=await axios.post("/api/convert",{text:e,narrator_name:t,selected_quote_pairs:n}),a=l.data.result;currentResult=a,document.querySelector("#splitPreviewJson code").textContent=a,Prism.highlightElement(document.querySelector("#splitPreviewJson code")),updateDialoguePreview(a,"splitPreviewDialogue")}catch(o){let i=`转换失败: ${o.response?.data?.error||o.message}`;document.querySelector("#splitPreviewJson code").textContent=`// ${i}`,document.getElementById("splitPreviewDialogue").innerHTML=`<p style="text-align: center; color: #e53e3e;">${i}</p>`}}function updateDialoguePreview(e,t){try{let n=JSON.parse(e),l=document.getElementById(t);if(l.innerHTML="",!n.actions||0===n.actions.length){l.innerHTML='<p style="text-align: center; color: #718096;">没有对话内容</p>';return}n.actions.forEach((e,t)=>{let n=!e.name||""===e.name.trim()||" "===e.name,a=document.createElement("div");if(a.className=`dialogue-item ${n?"narrator":""}`,a.style.animationDelay=`${.05*t}s`,!n){let o=document.createElement("div");o.className="dialogue-avatar",o.textContent=e.name.charAt(0);let i=e.characters&&e.characters[0]?e.characters[0]:0;o.style.background=getAvatarGradient(i),a.appendChild(o)}let r=document.createElement("div");if(r.className="dialogue-content",!n){let s=document.createElement("div");s.className="dialogue-name",s.textContent=e.name,r.appendChild(s)}let d=document.createElement("div");d.className="dialogue-text",d.textContent=e.body,r.appendChild(d),a.appendChild(r),l.appendChild(a)})}catch(a){container.innerHTML=`<p style="text-align: center; color: #e53e3e;">预览失败: ${a.message}</p>`}}function getAvatarGradient(e){let t=["linear-gradient(135deg, #667eea 0%, #764ba2 100%)","linear-gradient(135deg, #f093fb 0%, #f5576c 100%)","linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)","linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)","linear-gradient(135deg, #fa709a 0%, #fee140 100%)","linear-gradient(135deg, #30cfd0 0%, #330867 100%)","linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)","linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)"];return t[e%t.length]}async function showDialoguePreview(){let e=document.getElementById("inputText").value.trim();if(!e){showStatus("请先输入要转换的文本！","error");return}let t=document.getElementById("narratorName").value||" ",n=getSelectedQuotes();try{let l=await axios.post("/api/convert",{text:e,narrator_name:t,selected_quote_pairs:n});updateDialoguePreview(l.data.result,"dialogueContainer"),openModal("dialoguePreviewModal")}catch(a){showStatus(`预览失败: ${a.response?.data?.error||a.message}`,"error")}}function formatTextSplit(){let e=document.getElementById("splitInputText"),t=e.value;if(!t.trim()){showStatus("文本内容为空，无需格式化。","info");return}let n=t.split(/\r?\n/),l=n.map(e=>e.trim()).filter(e=>e.length>0),a=l.join("\n\n");e.value=a,showStatus("文本已成功格式化！","success"),autoPreviewEnabled&&updateSplitPreview()}function downloadSplitResult(){if(!currentResult){showStatus("没有可下载的结果！","error");return}let e=`result_${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.json`;axios.post("/api/download",{content:currentResult,filename:e},{responseType:"blob"}).then(t=>{let n=window.URL.createObjectURL(new Blob([t.data])),l=document.createElement("a");l.href=n,l.setAttribute("download",e),document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(n),showStatus("文件下载成功！","success")}).catch(e=>{showStatus(`下载失败: ${e.response?.data?.error||e.message}`,"error")})}async function handleFileUpload(e){let t=e.target.files[0];if(!t)return;let n=t.name.toLowerCase(),l=[".txt",".docx",".md"].some(e=>n.endsWith(e));if(!l){showStatus("只支持 .txt, .docx, .md 文件！","error");return}let a=new FormData;a.append("file",t);try{showProgress(20),showStatus("正在上传文件...","info");let o=await axios.post("/api/upload",a,{headers:{"Content-Type":"multipart/form-data"}});showProgress(100),document.getElementById("inputText").value=o.data.content,document.getElementById("splitInputText").value=o.data.content,showStatus("文件上传成功！","success"),setTimeout(()=>hideProgress(),1e3)}catch(i){showStatus(`文件上传失败: ${i.response?.data?.error||i.message}`,"error"),hideProgress()}}function updateBatchFileList(){let e=document.getElementById("batchFileInput"),t=document.getElementById("batchFileList");t.innerHTML="",(batchFiles=Array.from(e.files)).length>0?(batchFiles.forEach(e=>{let n=document.createElement("li"),l=e.name.endsWith(".docx")?"\uD83D\uDCC4":e.name.endsWith(".md")?"\uD83D\uDCDD":"\uD83D\uDCC3";n.textContent=`${l} ${e.name} (${(e.size/1024).toFixed(2)} KB)`,t.appendChild(n)}),document.getElementById("startBatchBtn").disabled=!1):document.getElementById("startBatchBtn").disabled=!0}function handleBatchDownload(){if(0===batchResults.length){showStatus("没有可下载的批量处理结果！","error");return}let e=new JSZip;batchResults.forEach(t=>{e.file(t.name,t.content)}),e.generateAsync({type:"blob"}).then(function(e){let t=`batch_results_${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.zip`;saveAs(e,t),showStatus("结果已打包下载！","success")}).catch(e=>{showStatus(`打包下载失败: ${e.message}`,"error")})}async function startBatchConversion(){if(0===batchFiles.length){showStatus("请先选择文件！","error");return}let e=document.getElementById("startBatchBtn");e.disabled=!0,e.innerHTML='<div class="loading"></div> 上传并准备中...';try{let t=await Promise.all(batchFiles.map(e=>new Promise((t,n)=>{let l=new FileReader,a=e.name.toLowerCase();a.endsWith(".docx")?(l.onload=()=>t({name:e.name,content:l.result,encoding:"base64"}),l.readAsDataURL(e)):(l.onload=()=>t({name:e.name,content:l.result,encoding:"text"}),l.readAsText(e)),l.onerror=n})));e.style.display="none",document.getElementById("batchProgressSection").style.display="block",document.getElementById("batchLogSection").style.display="block",document.getElementById("batchLogOutput").innerHTML="";let n=document.getElementById("narratorName").value||" ",l=getSelectedQuotes(),a=await axios.post("/api/batch_convert/start",{files:t,narrator_name:n,selected_quote_pairs:l}),{task_id:o}=a.data;if(o)pollBatchStatus(o);else throw Error("未能从服务器获取任务ID。")}catch(i){showStatus(`启动批量处理失败: ${i.response?.data?.error||i.message}`,"error"),e.disabled=!1,e.innerHTML="开始批量转换",e.style.display="inline-flex",document.getElementById("batchProgressSection").style.display="none",document.getElementById("batchLogSection").style.display="none"}}function pollBatchStatus(e){let t=setInterval(async()=>{try{let n=await axios.get(`/api/batch_convert/status/${e}`),l=n.data;document.getElementById("batchProgressBar").style.width=`${l.progress}%`,document.getElementById("batchStatusText").textContent=l.status_text;let a=document.getElementById("batchLogOutput");if(a.innerHTML=l.logs.join("<br>"),a.scrollTop=a.scrollHeight,"completed"===l.status){clearInterval(t),(batchResults=l.results||[]).length>0&&(document.getElementById("downloadBatchResultBtn").style.display="inline-flex");let o=document.querySelector("#batchConvertModal .btn-secondary");o&&(o.style.display="none"),showStatus("批量处理完成！","success")}}catch(i){clearInterval(t),document.getElementById("batchStatusText").textContent="轮询状态失败，任务可能已在后台完成或中断。",showStatus(`获取处理状态失败: ${i.message}`,"error")}},1500)}function openBatchModal(){document.getElementById("batchFileInput").value="";let e=document.getElementById("batchFileList");e&&(e.innerHTML="");let t=document.getElementById("batchProgressSection"),n=document.getElementById("batchLogSection"),l=document.getElementById("batchProgressBar"),a=document.getElementById("batchStatusText");t.style.display="none",n.style.display="none",l.style.width="0%",a.textContent="正在处理...",document.getElementById("downloadBatchResultBtn").style.display="none";let o=document.getElementById("startBatchBtn");o.style.display="inline-flex",o.disabled=!0,o.innerHTML="开始批量转换";let i=document.querySelector('#batchConvertModal .btn-secondary[onclick*="batchConvertModal"]');i&&(i.style.display="inline-flex"),batchFiles=[],batchResults=[],openModal("batchConvertModal")}function openModal(e){let t=document.getElementById(e);t&&(t.style.display="flex")}function closeModal(e){let t=document.getElementById(e);t&&(t.style.display="none")}function addCustomQuoteOption(){let e=document.getElementById("customQuoteOpen").value,t=document.getElementById("customQuoteClose").value;if(!e||!t){showStatus("起始和结束符号都不能为空！","error");return}let n=`${e}...${t}`,l=`quote-check-custom-${Date.now()}`;addCustomQuoteOptionToContainer(document.getElementById("quoteOptionsContainer"),l,n,e,t,!0);let a=document.getElementById("splitQuoteOptionsContainer");a&&addCustomQuoteOptionToContainer(a,l+"-split",n,e,t,!0),document.getElementById("customQuoteOpen").value="",document.getElementById("customQuoteClose").value=""}function setupFileDragDrop(){let e=document.getElementById("fileUpload");function t(e){e.preventDefault(),e.stopPropagation()}["dragenter","dragover","dragleave","drop"].forEach(n=>{e.addEventListener(n,t,!1)}),["dragenter","dragover"].forEach(t=>{e.addEventListener(t,()=>e.classList.add("dragover"),!1)}),["dragleave","drop"].forEach(t=>{e.addEventListener(t,()=>e.classList.remove("dragover"),!1)}),e.addEventListener("drop",handleDrop,!1)}function handleDrop(e){e.preventDefault(),e.stopPropagation();let t=e.dataTransfer,n=t.files;n.length>0&&(document.getElementById("fileInput").files=n,handleFileUpload({target:{files:n}}))}async function convertText(){let e=document.getElementById("inputText").value.trim(),t=document.getElementById("narratorName").value||" ";if(!e){showStatus("请输入要转换的文本！","error");return}let n=getSelectedQuotes(),l=document.getElementById("convertBtn"),a=document.getElementById("convertIcon"),o=document.getElementById("convertText");try{l.disabled=!0,a.innerHTML='<div class="loading"></div>',o.textContent="转换中...",showProgress(10),showStatus("正在处理文本...","info");let i=await axios.post("/api/convert",{text:e,narrator_name:t,selected_quote_pairs:n});showProgress(100),currentResult=i.data.result,document.getElementById("resultContent").textContent=currentResult,Prism.highlightElement(document.getElementById("resultContent")),document.getElementById("resultSection").style.display="block",showStatus("转换完成！","success"),document.getElementById("resultSection").scrollIntoView({behavior:"smooth"}),setTimeout(()=>hideProgress(),1e3)}catch(r){showStatus(`转换失败: ${r.response?.data?.error||r.message}`,"error"),hideProgress()}finally{l.disabled=!1,a.textContent="\uD83D\uDD04",o.textContent="开始转换"}}function formatText(){let e=document.getElementById("inputText"),t=e.value;if(!t.trim()){showStatus("文本内容为空，无需格式化。","info");return}let n=t.split(/\r?\n/),l=n.map(e=>e.trim()).filter(e=>e.length>0),a=l.join("\n\n");e.value=a,showStatus("文本已成功格式化！","success")}async function loadConfig(){try{let e=await axios.get("/api/config");currentConfig=e.data.character_mapping,quotesConfig=e.data.quotes_config,renderQuoteOptions()}catch(t){console.error("加载配置失败:",t),showStatus("无法加载应用配置","error")}}function renderQuoteOptions(){let e=document.getElementById("quoteOptionsContainer");e.innerHTML="",quotesConfig&&quotesConfig.quote_categories&&Object.entries(quotesConfig.quote_categories).forEach(([t,n])=>{let l=`quote-check-${t.replace(/\s/g,"-")}`,a=document.createElement("div");a.style.display="flex",a.style.alignItems="center";let o=document.createElement("input");o.type="checkbox",o.id=l,o.className="quote-option-checkbox",o.value=t,o.dataset.open=n[0],o.dataset.close=n[1],o.checked=!0;let i=document.createElement("label");i.htmlFor=l,i.textContent=t,i.style.marginLeft="8px",i.style.cursor="pointer",a.appendChild(o),a.appendChild(i),e.appendChild(a)})}function getSelectedQuotes(){let e=[];return document.querySelectorAll(".quote-option-checkbox:checked").forEach(t=>{let n=t.dataset.open,l=t.dataset.close;n&&l&&e.push([n,l])}),e}function openConfigModal(){renderConfigList(),openModal("configModal")}function renderConfigList(){let e=document.getElementById("configList");e.innerHTML="";let t=Object.entries(currentConfig).sort(([,e],[,t])=>{let n=e&&e.length>0?e[0]:1/0,l=t&&t.length>0?t[0]:1/0;return n-l});t.forEach(([t,n])=>{let l=document.createElement("div");l.className="config-item",l.innerHTML=`
            <input type="text" placeholder="角色名称" value="${t}" class="form-input config-name">
            <input type="text" placeholder="ID列表(逗号分隔)" value="${n.join(",")}" class="form-input config-ids">
            <button class="remove-btn" onclick="removeConfigItem(this)">删除</button>
        `,e.appendChild(l)})}function addConfigItem(){let e=document.getElementById("configList"),t=document.createElement("div");t.className="config-item",t.innerHTML=`
        <input type="text" placeholder="角色名称" class="form-input config-name">
        <input type="text" placeholder="ID列表(逗号分隔)" class="form-input config-ids">
        <button class="remove-btn" onclick="removeConfigItem(this)">删除</button>
    `,e.prepend(t)}function removeConfigItem(e){e.parentElement.remove()}async function saveConfig(){let e=document.querySelectorAll(".config-item"),t={};e.forEach(e=>{let n=e.querySelector(".config-name").value.trim(),l=e.querySelector(".config-ids").value.trim();if(n&&l){let a=l.split(",").map(e=>parseInt(e.trim())).filter(e=>!isNaN(e));a.length>0&&(t[n]=a)}});try{await axios.post("/api/config",{character_mapping:t}),currentConfig=t,showStatus("配置保存成功！","success"),closeModal("configModal")}catch(n){showStatus(`配置保存失败: ${n.response?.data?.error||n.message}`,"error")}}function downloadResult(){if(!currentResult){showStatus("没有可下载的结果！","error");return}let e=`result_${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.json`;axios.post("/api/download",{content:currentResult,filename:e},{responseType:"blob"}).then(t=>{let n=window.URL.createObjectURL(new Blob([t.data])),l=document.createElement("a");l.href=n,l.setAttribute("download",e),document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(n),showStatus("文件下载成功！","success")}).catch(e=>{showStatus(`下载失败: ${e.response?.data?.error||e.message}`,"error")})}function showProgress(e){document.getElementById("progressContainer").style.display="block",document.getElementById("progressFill").style.width=e+"%"}function hideProgress(){document.getElementById("progressContainer").style.display="none",document.getElementById("progressFill").style.width="0%"}function showStatus(e,t){let n=document.getElementById("statusMessage");n&&(n.textContent=e,n.className=`status-message status-${t}`,n.style.display="block")}function initializeSplitResizer(){let e=document.getElementById("splitResizer"),t=document.querySelector(".left-panel"),n=document.querySelector(".right-panel"),l=document.querySelector(".split-container");if(!e)return;let a=!1,o=0,i=0;e.addEventListener("mousedown",e=>{a=!0,o=e.clientX,i=t.offsetWidth,document.body.style.cursor="col-resize",document.body.style.userSelect="none",e.preventDefault()}),document.addEventListener("mousemove",r=>{if(!a)return;let s=r.clientX-o,d=l.offsetWidth,c=i+s,u=d-300-e.offsetWidth;if(c>=300&&c<=u){let p=c/d*100,g=100-p-e.offsetWidth/d*100;t.style.flex=`0 0 ${p}%`,n.style.flex=`0 0 ${g}%`}}),document.addEventListener("mouseup",()=>{a&&(a=!1,document.body.style.cursor="",document.body.style.userSelect="")})}function openSplitQuoteModal(){let e=document.getElementById("quoteOptionsContainer"),t=document.getElementById("splitQuoteOptionsContainer");t.innerHTML=e.innerHTML,t.querySelectorAll(".quote-option-checkbox").forEach((t,n)=>{let l=e.querySelectorAll(".quote-option-checkbox")[n];t.checked=l.checked,t.addEventListener("change",()=>{l.checked=t.checked,autoPreviewEnabled&&updateSplitPreview()})}),openModal("splitQuoteModal")}function addSplitCustomQuoteOption(){let e=document.getElementById("splitCustomQuoteOpen").value,t=document.getElementById("splitCustomQuoteClose").value;if(!e||!t){showStatus("起始和结束符号都不能为空！","error");return}let n=`${e}...${t}`,l=`quote-check-custom-${Date.now()}`;addCustomQuoteOptionToContainer(document.getElementById("quoteOptionsContainer"),l,n,e,t,!0),addCustomQuoteOptionToContainer(document.getElementById("splitQuoteOptionsContainer"),l+"-split",n,e,t,!0),document.getElementById("splitCustomQuoteOpen").value="",document.getElementById("splitCustomQuoteClose").value="",autoPreviewEnabled&&updateSplitPreview()}function addCustomQuoteOptionToContainer(e,t,n,l,a,o){let i=document.createElement("div");i.style.display="flex",i.style.alignItems="center";let r=document.createElement("input");r.type="checkbox",r.id=t,r.dataset.open=l,r.dataset.close=a,r.className="quote-option-checkbox",r.checked=o;let s=document.createElement("label");s.htmlFor=t,s.textContent=n,s.style.marginLeft="8px",s.style.cursor="pointer",i.appendChild(r),i.appendChild(s),e.appendChild(i)}function syncConfigToSplit(){let e=document.getElementById("narratorName").value;document.getElementById("splitNarratorName").value=e}document.addEventListener("DOMContentLoaded",initializeApp),window.addEventListener("click",function(e){let t=document.querySelectorAll(".modal");t.forEach(t=>{e.target===t&&closeModal(t.id)})}),window.addEventListener("keydown",function(e){if("Escape"===e.key){let t=document.querySelectorAll(".modal");t.forEach(e=>{closeModal(e.id)})}});